# Authentication Performance & Security Guide

## –ü—Ä–æ–±–ª–µ–º–∞

–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ `supabase.auth.getUser()` –∑–∞–Ω–∏–º–∞–ª ~300ms –∏–∑-–∑–∞:
1. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–∑–æ–≤–æ–≤ –≤ middleware (2 –≤—ã–∑–æ–≤–∞ –Ω–∞ –∑–∞–ø—Ä–æ—Å)
2. –°–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Å–µ—Ä–≤–µ—Ä—É Supabase –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ JWT
3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
4. –ü—Ä—è–º—ã—Ö –≤—ã–∑–æ–≤–æ–≤ `supabase.auth.getUser()` –≤ API —Ä–æ—É—Ç–∞—Ö

## –†–µ—à–µ–Ω–∏–µ

### 1. –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–∑–æ–≤–æ–≤ ‚úÖ
- –£–±—Ä–∞–ª–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ `getUser()` –≤ middleware
- –¢–µ–ø–µ—Ä—å –æ–¥–∏–Ω –≤—ã–∑–æ–≤ –≤–º–µ—Å—Ç–æ –¥–≤—É—Ö –Ω–∞ –∑–∞–ø—Ä–æ—Å

### 2. –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ ‚úÖ
```typescript
// ‚ùå –û–ü–ê–°–ù–û - –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
let userCache = { user, timestamp }; // –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —É–≤–∏–¥–µ—Ç—å –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–æ–≥–æ!

// ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û - –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ä–∞–º–∫–∞—Ö –∑–∞–ø—Ä–æ—Å–∞
const getCachedUser = cache(async () => { ... }); // React cache - –∏–∑–æ–ª–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º
```

### 3. –ó–∞–º–µ–Ω–∞ –ø—Ä—è–º—ã—Ö –≤—ã–∑–æ–≤–æ–≤ ‚úÖ
–ó–∞–º–µ–Ω–∏–ª–∏ –ø—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã `supabase.auth.getUser()` –Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤:
- `/api/auth/user` - –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–æ—É—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- `/api/form-builder/import-word` - –∏–º–ø–æ—Ä—Ç Word –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- Middleware - —É—Å—Ç—Ä–∞–Ω–∏–ª–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

### 4. –õ–æ–∫–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è JWT (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ‚ö†Ô∏è
```typescript
// –¢—Ä–µ–±—É–µ—Ç SUPABASE_JWT_SECRET –≤ environment variables
const user = await getAuthenticatedUser(true); // –õ–æ–∫–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
```

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã:
- `lib/supabase/server.ts` - –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- `lib/supabase/middleware.ts` - middleware helper
- `middleware.ts` - –æ—Å–Ω–æ–≤–Ω–æ–π middleware
- `app/api/auth/user/route.ts` - API —Ä–æ—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `app/api/form-builder/import-word/route.ts` - –∏–º–ø–æ—Ä—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

### ‚ö†Ô∏è –¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫–ª–∏–µ–Ω—Ç—Å–∫—É—é –≤–µ—Ä—Å–∏—é):
- `lib/supabase/forms.ts` - —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ñ–æ—Ä–º
- `lib/supabase/user-sync.ts` - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `lib/supabase/client.ts` - –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏

## API Functions

### `getAuthenticatedUser(useLocalValidation = false)`
- **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í —Ä–∞–º–∫–∞—Ö –∑–∞–ø—Ä–æ—Å–∞ (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –û–±—ã—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: ~50ms –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤—ã–∑–æ–≤–∞ –≤ –∑–∞–ø—Ä–æ—Å–µ

### `getAuthenticatedUserFresh(useLocalValidation = false)`
- **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ù–µ—Ç
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –≥–¥–µ –Ω—É–∂–Ω—ã —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: ~150ms (–±–µ–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏)

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏

1. –ü–æ–ª—É—á–∏—Ç–µ JWT Secret –∏–∑ Supabase Dashboard ‚Üí Settings ‚Üí API
2. –î–æ–±–∞–≤—å—Ç–µ –≤ environment variables:
```bash
SUPABASE_JWT_SECRET=your_jwt_secret_here
```

3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å —Ñ–ª–∞–≥–æ–º:
```typescript
const user = await getAuthenticatedUser(true); // ~15ms
```

## –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

| –ú–µ—Ç–æ–¥ | –í—Ä–µ–º—è | –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | –°—Ç–∞—Ç—É—Å |
|-------|-------|--------------|--------|
| –ò—Å—Ö–æ–¥–Ω—ã–π (2 –≤—ã–∑–æ–≤–∞) | ~600ms | ‚úÖ | ‚ùå –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π | ~150ms | ‚úÖ | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| –° –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º | ~15ms (–ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã) | ‚úÖ | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| –° –ª–æ–∫–∞–ª—å–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π | ~5ms | ‚úÖ | ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ |

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### ‚úÖ –ß—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ:
- `cache()` –æ—Ç React - –∏–∑–æ–ª–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º
- –õ–æ–∫–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è JWT —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ–¥–ø–∏—Å–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚ùå –ß—Ç–æ –ù–ï –±–µ–∑–æ–ø–∞—Å–Ω–æ:
- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
- –î–æ–≤–µ—Ä–∏–µ –∫ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É cookie –±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –£—Ç–µ—á–∫–∞ JWT secret –Ω–∞ –∫–ª–∏–µ–Ω—Ç

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–î–ª—è –æ–±—ã—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**: `getAuthenticatedUser()`
2. **–î–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**: `getAuthenticatedUserFresh()`
3. **–î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é
4. **–î–ª—è middleware**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å JWT Secret** –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Å—Ç–∞–≤—à–∏–µ—Å—è API —Ä–æ—É—Ç—ã** –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä—è–º—ã—Ö –≤—ã–∑–æ–≤–æ–≤
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
4. **–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ Redis** –¥–ª—è production

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–§—É–Ω–∫—Ü–∏–∏ –≤–∫–ª—é—á–∞—é—Ç console.time –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
- `supabaseClient`: –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
- `supabase.auth.getUser`: –í—Ä–µ–º—è —Å–µ—Ç–µ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- `localJWTValidation`: –í—Ä–µ–º—è –ª–æ–∫–∞–ª—å–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏

## –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

‚úÖ **–û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã**
‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ JWT Secret –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
üîÑ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ** 